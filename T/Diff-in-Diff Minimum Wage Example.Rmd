---
title: "Mininimum Wage Example Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

This notebook implements Difference-in-Differences in an application on the effect of minimum wage changes on teen employment. We use data from [Callaway (2022)](https://bcallaway11.github.io/files/Callaway-Chapter-2022/main.pdf), for further details on the analysis, please read his paper. The observations are US counties, with the outcome being county-level teen employment. Data was collected in a time period from 2001-2007 where the federal minimum wage was constant.

Counties that have minimum wages above the federal minimum wage are classified as being treated. 27 Additional county characteristics come from IPUMS National Historical GIS (county population) and QCEW County Employment and Wages (county average annual pay) and will be used as covariates. The dataset ultimately includes a balanced panel of counties from 42 states from 2001-2007. See [Callaway and Sant'Anna (2021)](https://www.sciencedirect.com/science/article/abs/pii/S0304407620303948) for additional details on the data.

First, we will load some libraries.

```{r}
library(did)
library(BMisc)
library(fixest)
library(bacondecomp)
library(ggplot2)
library(modelsummary)
library(HonestDiD)
library(didimputation)
library(tidyr)
library(dplyr)

set.seed(772023)
setwd("X:/Downloads/Examples")

# load helper functions from Callaway (2021)
source("notebook_helpers.R")
```

We load the data and preprocess it analogously to [Callaway (2022)](https://bcallaway11.github.io/files/Callaway-Chapter-2022/main.pdf).

```{r}
load("mw_data_ch.RData")
data <- mw_data_ch
rm(mw_data_ch)
data <- subset(data, emp0A01_BS > 0)
data <- subset(data, annual_avg_pay > 0)
data <- data[complete.cases(data[,-c("state_mw", "fed_mw")]),]
data <- makeBalancedPanel(data, "countyreal", "year")
data$lemp <- log(data$emp0A01_BS)
data$pop <- as.numeric(data$pop)
data$lpop <- log(data$pop)
data$lavg_pay <- log(data$annual_avg_pay)
data$region <- 1*(data$censusdiv==1 | data$censusdiv==2) + 2*(data$censusdiv==3 | data$censusdiv==4) +
  3*(data$censusdiv==5 | data$censusdiv==6 | data$censusdiv==7) + 4*(data$censusdiv==8 | data$censusdiv==9)
data$region <- as.factor(data$region)
data$ever_treated <- 1*(data$G != 0)
data$id <- data$countyreal
```

**Summary Statistics**

We are going to compare the groups of treated and untreated counties in some summary statistics. Treated refers to counties that had a minimum wage higher than the ferderal minimum wage in any period from 2002-2007. The comparison will be for 2001, as this is pre-treatment for all observations. It is evident, that counties in the treated group had already before treatment a significantly higher teen employment. Also, they tend to have higher population. The average pay shows no mayor deviation between treated and non-treated group. Counties that are not treated are more likely in region 3, which is the south. Meanwhile in region 1, referring to the northeast, there is not a single observation of a county without treatment.

```{r}
data2 <- subset(data, (G==0) | (G>2001))
data2$fever_treated <- as.factor(data2$ever_treated)
data2$emp100 <- data2$emp0A01_BS/100
data2$pop1000 <- data2$pop/1000
data2$pay1000 <- data2$annual_avg_pay/1000
datasummary_balance(~ fever_treated,
                    data=dplyr::select(subset(data2,year==2001),
                                       emp100,
                                       pop1000,
                                       pay1000,
                                       region,
                                       fever_treated),
                    dinm=FALSE)
```

**Subsets of the data**

The further analysis will run on different subsets of the data that we will discuss, namely:

-   **Data 1**: Full data - uses all available states/counties and time periods (2001-2007)

-   **Data 2**: No already treated - drops states/counties that are already treated at the beginning of the period

-   **Data 3**: No never treated - drops states/counties that do not participate in the treatment in any time period

-   **Data 4**: No never treated and no already treated - drops states/counties that are never-treated or that are already treated at the beginning of the period (i.e., this only includes observations that show up in both Data 2 and Data 3)

-   **Data 5**: No early periods - drops states/counties that are never-treated or that are already treated at the beginning of the period and also only includes years from 2004-2007 (i.e., the subset of Data 4 that only includes years from 2004-2007).

```{r}
# data 2 was already created above
# drop never-treated 
data3 <- subset(data, G!=0)

# additionally drop always-treated
data4 <- subset(data3, G > 2001)

# drop years 2004 or earlier
data5 <- subset(data4, year > 2004)
```

**Group-Time Average Treatment Effect**

We use the `did` package to estimate the average treatment effect on the treated in different time periods, compared to the group of never-treated. The package implements the group-time average treatment effect estimator of [Callaway and Sant'Anna (2021)](https://www.sciencedirect.com/science/article/abs/pii/S0304407620303948).

```{r, fig.height=12}
cs_res <- att_gt(yname="lemp",
                 tname="year",
                 idname="countyreal",
                 gname="G",
                 data=data2,
                 base_period ="varying",
                 control_group="nevertreated",
                 cband=FALSE)
ggdid(cs_res, ylim=c(-.18,.12), ncol=2)
```

We see a notable treatment effect heterogeneity across groups, time, and particularly with length of exposure to the treatment (with most groups tending to experience larger negative effects at longer lengths of exposure). The parallel trends assumption appears to be violated for some groups, as there is a significant deviation from zero effect in pre-treatment periods.

**Two-Way Fixed Effects Regression**

Next, we want to estimate an *overall* causal effect. Two-way fixed effects (TWFE) regressions is an often used approach to implement DiD identification strategies. In this setting, we assume

$$Y_{it} = \theta_t + \eta_i + \alpha D_{it}+\nu_{it} $$where $Y_{it}$ is the outcome of interest, $\theta_t$ is a time fixed effect, $\eta_i$ is a unit fixed effect, $D_{it}$ is an indicator for whether or not unit $i$ participated in the treatment in time period $t$, and $\nu_{it}$ are idiosyncratic, time-varying unobservables. Under parallel trends assumption, $\alpha$ can be interpreted as causal effect of participating in the treatment. Note that this is not valid under effect heterogeneity.

```{r}
twfe1 <- feols(lemp ~ treated | countyreal + year,
               data=data)
twfe2 <- feols(lemp ~ treated | countyreal + year,
               data=data2)
twfe3 <- feols(lemp ~ treated | countyreal + year,
               data=data3)
twfe4 <- feols(lemp ~ treated | countyreal + year,
               data=data4)
twfe5 <- feols(lemp ~ treated | countyreal + year,
               data=data5)

# print results
modelsummary(list(twfe1, twfe2, twfe3, twfe4, twfe5),
             stars=TRUE)

```

The results vary notably across different datasets with estimates ranging from minimum wage changes decreasing teen employment by 3.7% on average (relative to teen employment in the absence of the minimum wage change) to minimum wage changes increasing teen employment by 1.1% (which is marginally statistically significant). Interestingly, these estimates essentially cover the range of estimates of minimum wage effects in the literature.

We compare these estimates with the estimates we get from different versions of the Callaway and Sant' Anne estimator. These aggregate the group-time average treatment effects to get an estimate of the average treatment effect on the treated $ATT = \mathbb{E}[Y_{i1}(1)- Y_{i1}(0)|D_i=1]$, with $Y_{i1}$ indicating that we are comparing the post-treatment outcomes. For simplicity of comparison, we only use sub-dataset `data2`.

First, we aggregate the estimates with the never-treated as control group.

```{r}
cs_o <- aggte(cs_res, type="group")
res_df <- cbind.data.frame(att=cs_o$overall.att, se=cs_o$overall.se, ci_low=cs_o$overall.att-1.96*cs_o$overall.se, ci_up=cs_o$overall.att+1.96*cs_o$overall.se)
res_df
```

We can also add covariates for potential confounding. In the estimator with control variables, we control for the log of county population, the log of county average annual pay, and region fixed effects.

```{r}
csX_res <- att_gt(yname="lemp",
                 tname="year",
                 idname="countyreal",
                 gname="G",
                 data=subset(data2, region !=1),
                 xformla=~lpop + lavg_pay + region,
                 base_period ="varying",
                 control_group="nevertreated")
csX_o <- aggte(csX_res, type="group", na.rm=TRUE)
res_df <- cbind.data.frame(att=csX_o$overall.att, se=csX_o$overall.se, ci_low=csX_o$overall.att-1.96*csX_o$overall.se, ci_up=csX_o$overall.att+1.96*csX_o$overall.se)
res_df
```

Next, we use the group of not-yet-treated as control group.

```{r}
cs_res <- att_gt(yname="lemp",
                 tname="year",
                 idname="countyreal",
                 gname="G",
                 data=data2,
                 base_period ="varying",
                 control_group="notyettreated",
                 cband=FALSE)
cs_o <- aggte(cs_res, type="group")
res_df <- cbind.data.frame(att=cs_o$overall.att, se=cs_o$overall.se, ci_low=cs_o$overall.att-1.96*cs_o$overall.se, ci_up=cs_o$overall.att+1.96*cs_o$overall.se)
res_df
```

And do the same with covariates.

```{r}
csX_res <- att_gt(yname="lemp",
                 tname="year",
                 idname="countyreal",
                 gname="G",
                 data=subset(data2, region !=1),
                 xformla=~lpop + lavg_pay + region,
                 base_period ="varying",
                 control_group="notyettreated")
csX_o <- aggte(csX_res, type="group", na.rm=TRUE)
res_df <- cbind.data.frame(att=csX_o$overall.att, se=csX_o$overall.se, ci_low=csX_o$overall.att-1.96*csX_o$overall.se, ci_up=csX_o$overall.att+1.96*csX_o$overall.se)
res_df
```

Finally, there is also the imputation estimator by [Liu, Wang and Xu (2021)](https://doi.org/10.1111/ajps.12723). This estimator is slightly different than the procedure above. It first estimates a model for the potential outcomes of untreated units and then uses these "imputed outcomes" to compare them to the actual observed ones.

```{r}
imp <- did_imputation(yname="lemp",
            tname="year",
            idname="countyreal",
            gname="G",
            data=data2)
imp
```

The estimates are overall very similar to the TWFE regression estimates and all suggest a significantly negative influence of minimum wages on teen employment

**Event Study Regression**

The regressions so far focused on a single target parameter, interpreted as "the" causal effect. Another common target parameter is the event study which estimates $ATT^{ES}(e)$ with $e$ being the proximity to the treatment in time-periods ($e=0$ is the first post-treatment period) . This is particularly useful to understand treatment effect dynamics, i.e. how the effect of participating in the treatment varies with length of exposure. Event Studies are also useful to test if the parallel trend assumption holds. If we estimate $ATT^{ES}(e=\tilde{e}<0)\neq0$, this might be not the case.

```{r}
cs_dyn <- aggte(cs_res, type="dynamic")
plot_df1 <- cbind.data.frame(att=cs_dyn$att.egt, ciL=cs_dyn$att.egt-1.96*cs_dyn$se.egt, ciU=cs_dyn$att.egt+1.96*cs_dyn$se.egt, e=cs_dyn$egt, type="CS")

this_data <- data2
this_data$e <- ifelse(this_data$G==0, 0, this_data$year - this_data$G)
twfe_es <- feols(lemp ~ i(e, ever_treated, ref=-1) | countyreal + year,
                 data=this_data)

twfe_plot_data <- iplot(twfe_es)
plot_df2 <- cbind.data.frame(att=twfe_plot_data$prms$estimate,
                             ciL=twfe_plot_data$prms$ci_low,
                             ciU=twfe_plot_data$prms$ci_high,
                             e=twfe_plot_data$prms$estimate_names,
                             type="ES Reg. Data 2")


data$e <- ifelse(data$G==0, 0, data$year - data$G)
twfe_es_all <- feols(lemp ~ i(e, ever_treated, ref=-1) | countyreal + year,
                 data=data)
twfe_all_plot_data <- iplot(twfe_es_all)
plot_df3 <- cbind.data.frame(att=twfe_all_plot_data$prms$estimate,
                             ciL=twfe_all_plot_data$prms$ci_low,
                             ciU=twfe_all_plot_data$prms$ci_high,
                             e=twfe_all_plot_data$prms$estimate_names,
                             type="ES Reg. Data 1")

plot_df <- rbind.data.frame(plot_df1, plot_df2, plot_df3)

ggplot(data=plot_df, mapping=aes(x=e,y=att,color=type,fill=type)) +
  geom_point(position=position_dodge(width=.2)) +
  geom_errorbar(aes(ymin=ciL, ymax=ciU), position=position_dodge(width=.2), width=.5) +
  theme_classic() +
  scale_x_continuous(breaks=seq(-6,6)) +
  theme(legend.position="bottom", legend.title=element_blank()) 
```

While we see, that the estimates in the first post-treatment period are very similar across methods and sub-datasets, the more periods we move away from treatment, the less certain the estimates are.

**Sensitivity Analysis**

The result of the event study above also suggest that there appear to be some violations of parallel trends in pre-treatment periods (e.g. at $e=-2$, all estimates are significantly different from 0). That would be a limitation to effect identification with DiD. We perform a sensitivity analysis with the methodology of [Rambachan and Roth (2022)](https://doi.org/10.1093/restud/rdad018), namely we specify different values for `Mbarvec` which is an assumption on how bad the post-treatment violation of parallel trends can be. We then get confidence bands for the treatment effect parameter. We perform sensitivity analysis for the first post-treatment period.

```{r}
# redo event study with universal base period
cs_res <- att_gt(yname="lemp",
                 tname="year",
                 idname="countyreal",
                 gname="G",
                 data=data2,
                 base_period ="universal",
                 control_group="nevertreated",
                 cband=FALSE)
cs_dyn <- aggte(cs_res, type="dynamic")

hd_rm <- honest_did(es=cs_dyn, type="relative_magnitude", Mbarvec=c(0.5,1,1.5,2), gridPoints=100, grid.lb=-.25, grid.ub=.25, e=0)

createSensitivityPlot_relativeMagnitudes(hd_rm$robust_ci,
                                         hd_rm$orig_ci) +
  theme_classic() +
  scale_color_discrete("", labels=c("Original", "RR Bounds")) +
  theme(legend.position="bottom")
```

The results indicate that the earlier conclusions are robust (in the sense of being statistically different from 0) to violations of parallel trends only up to half as large as were observed in pre-treatment periods. Allowing for violations of parallel trends as large as were observed in pre-treatment periods, the confidence set ranges from -0.073 to 0.023. This could imply a wide range of multiple effects of minimum wage on teen employment, including no effect.
